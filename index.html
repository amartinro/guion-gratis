<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guión gratis para tu próximo Reel — por Alberto Martín</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Genera un guion corto GPS (gancho-problema-solución) para tu negocio en 30s. 100% gratis.">
  <style>
    /* Fondo con gradiente sutil */
    .bg-grid {
      background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,0.25), transparent 60%),
                  radial-gradient(800px 400px at 100% 0%, rgba(16,185,129,0.18), transparent 55%),
                  radial-gradient(600px 600px at 30% 100%, rgba(99,102,241,0.12), transparent 60%);
    }
  </style>
</head>
<body class="h-full bg-neutral-950 text-neutral-100 bg-grid">
  <header class="max-w-3xl mx-auto px-4 pt-10 pb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">
          Guión corto para tu próximo Reel <br /><span class="text-indigo-400 font-bold">GRATIS</span>
        </h1>
        <p class="mt-2 text-neutral-400">Estructura GPS (gancho–problema–solución) en 8–12s. Ideal para negocios locales.</p>
      </div>
      <a href="https://www.instagram.com/amartinro/" target="_blank" rel="noopener" class="group inline-flex items-center gap-2 text-sm text-neutral-300 hover:text-white">
        <!-- Simple Instagram-like icon -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="opacity-80 group-hover:opacity-100">
          <rect x="3" y="3" width="18" height="18" rx="5" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="17.5" cy="6.5" r="1.2" fill="currentColor"/>
        </svg>
        <span class="font-medium">Alberto Martín</span>
      </a>
    </div>
    <!-- <div class="mt-3">
      <a href="https://www.instagram.com/amartinro/" target="_blank" rel="noopener" class="text-xs text-indigo-300 hover:text-indigo-200 underline">@amartinro</a>
    </div> -->
  </header>

  <main class="max-w-3xl mx-auto px-4 pb-16">
    <section class="rounded-2xl border border-neutral-800 bg-neutral-900/70 shadow-xl backdrop-blur p-6 md:p-8">
      <form id="guion-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-neutral-300">Nombre*</label>
            <input name="nombre" required maxlength="80" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-neutral-300">Teléfono (contacto)</label>
            <input name="telefono" placeholder="+34 6XX XXX XXX" inputmode="tel" maxlength="18" title="+34 6XX XXX XXX" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-neutral-300">Email*</label>
            <input name="email" required class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <!-- <div>
            <label class="block text-sm text-neutral-300">Teléfono (contacto)</label>
            <input name="telefono" placeholder="+34 6XX XXX XXX" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div> -->
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-neutral-300">Instagram (@sin @)*</label>
            <input name="instagram" required placeholder="nombredeusuario" pattern="^[A-Za-z0-9._]{1,30}$" maxlength="30" title="Solo letras, números, punto o guion bajo" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-neutral-300">Ciudad</label>
            <input name="ciudad" placeholder="Salamanca" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
        </div>

        <div>
          <label class="block text-sm text-neutral-300">Sector/negocio (1 frase)*</label>
          <input name="sector" required maxlength="120" placeholder="Pizzería artesana, horno de leña" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div>
          <label class="block text-sm text-neutral-300">¿Qué buscas obtener? <span class="text-neutral-400">(autoridad, alcance, ventas; e indica 3 frenos habituales: falta de tiempo, pocas ideas, baja retención)</span>*</label>
          <textarea name="objetivo" required rows="3" maxlength="500" placeholder="Ej.: autoridad en mi zona, más alcance orgánico, ventas del menú del día; frenos: falta de tiempo, pocas ideas, baja retención" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>

        <div>
          <label class="block text-sm text-neutral-300">¿En qué destaca tu negocio sobre la competencia?*</label>
          <textarea name="diferencial" required rows="3" maxlength="500" placeholder="Ej.: horno de leña, producto local, reseñas 4,8★, rapidez en entrega, ubicación céntrica, parking propio..." class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>

        <!-- <div>
          <label class="block text-sm text-neutral-300">Competidor (URL de Instagram, opcional)</label>
          <input name="competidor" placeholder="https://instagram.com/competidor" pattern="^$|^https?:\\/\\/(?:www\\.)?instagram\\.com\\/.*" title="Solo URLs de Instagram" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 placeholder-neutral-500 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div> -->

        <!-- Honeypot para bots -->
        <div class="hidden" aria-hidden="true">
          <label>Empresa
            <input name="empresa" autocomplete="off" tabindex="-1" class="mt-1 w-full rounded-xl border border-neutral-700 bg-neutral-800 text-neutral-100 px-3 py-2">
          </label>
        </div>
        <!-- Cloudflare Turnstile (dark) -->
        <div class="mt-2">
          <div class="cf-turnstile" data-sitekey="0x4AAAAAAB319LvRRrr4YA6R" data-theme="dark" data-callback="onTS"></div>
        </div>

        <details class="text-xs text-neutral-400 mt-2">
          <summary class="cursor-pointer underline underline-offset-2 decoration-neutral-600 hover:decoration-indigo-500">Política de protección de datos (UE) — resumen</summary>
          <div class="mt-2 space-y-2">
            <p><strong>Responsable:</strong> Alberto Martín · Contacto: a.martinro@gmail.com.</p>
            <p><strong>Finalidad:</strong> generar el guion solicitado, mantener contacto comercial y gestionar citas.</p>
            <p><strong>Legitimación:</strong> tu consentimiento al marcar la casilla y, en su caso, interés legítimo para comunicaciones relacionadas con tu solicitud.</p>
            <p><strong>Destinatarios/Encargados:</strong> Cloudflare (hosting y seguridad), Google (Google Sheets, si lo configuras). No se prevén transferencias fuera de la UE sin garantías adecuadas.</p>
            <p><strong>Conservación:</strong> hasta 12 meses o hasta que solicites su supresión.</p>
            <p><strong>Derechos:</strong> acceso, rectificación, supresión, oposición, limitación y portabilidad. Puedes ejercerlos en a.martinro@gmail.com.</p>
            <p><strong>Información adicional:</strong> consulta la Política de Privacidad completa en <a href="politica-privacidad.html" target="_blank" class="underline">este enlace</a>.</p>
          </div>
        </details>

        <label class="flex items-center gap-2 text-sm mt-2">
          <input type="checkbox" name="consent" required class="h-4 w-4 accent-indigo-600">
          <span>He leído y acepto la <a href="politica-privacidad.html" target="_blank" class="underline">Política de Privacidad</a>.</span>
        </label>

        <button id="submit-btn" type="submit" class="mt-3 w-full md:w-auto rounded-xl bg-indigo-600 text-white px-5 py-2.5 font-semibold hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400">Generar guion</button>
        <p id="msg" class="text-sm text-neutral-400 inline-block ml-3"></p>
      </form>
    </section>

    <section id="resultado" class="hidden mt-8 rounded-2xl border border-neutral-800 bg-neutral-900/70 shadow-xl backdrop-blur p-6 md:p-8">
      <h2 class="text-2xl font-semibold">Tu guion GPS</h2>
      <div id="guion" class="mt-3 space-y-1 text-neutral-200"></div>

      <h3 class="text-xl font-semibold mt-6">Plano a plano</h3>
      <div id="plano" class="mt-2 space-y-2 text-neutral-200"></div>

      <h3 class="text-xl font-semibold mt-6">3 variantes de gancho</h3>
      <ul id="variantes" class="list-disc pl-5 mt-2 space-y-1 text-neutral-200"></ul>

      <h3 class="text-xl font-semibold mt-6">Checklist DIY</h3>
      <ul id="checklist" class="list-disc pl-5 mt-2 space-y-1 text-neutral-200"></ul>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Copiar guion (secundario) -->
        <button id="copiar" type="button"
          class="w-full rounded-xl border border-neutral-700 bg-neutral-800 px-4 py-3 font-semibold text-neutral-100 hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          Copiar guion
        </button>

        <!-- WhatsApp CTA (principal) -->
        <a id="whatsapp" target="_blank" rel="noopener"
          class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 font-semibold text-white hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-400">
          <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="opacity-90">
            <path d="M20.52 3.48A11.94 11.94 0 0 0 12 0C5.37 0 0 5.37 0 12a11.9 11.9 0 0 0 1.74 6.18L0 24l6.09-1.72A11.9 11.9 0 0 0 12 24c6.63 0 12-5.37 12-12 0-3.2-1.25-6.21-3.48-8.52Zm-8.52 18a9.9 9.9 0 0 1-5.05-1.39l-.36-.21-3.61 1.02 1.03-3.51-.24-.37A9.9 9.9 0 0 1 2 12C2 6.93 6.93 2 12 2s10 4.93 10 10-4.93 10-10 10Zm5.55-7.49c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.3-.77.96-.95 1.16-.17.2-.35.23-.64.08-.3-.15-1.25-.46-2.38-1.47-.88-.78-1.47-1.74-1.64-2.03-.17-.3-.02-.46.13-.6.14-.14.3-.35.45-.53.15-.18.2-.3.3-.5.1-.2.05-.38-.02-.53-.08-.15-.67-1.6-.92-2.19-.24-.58-.49-.5-.67-.5-.17 0-.38-.02-.58-.02-.2 0-.53.08-.81.38-.27.3-1.06 1.03-1.06 2.51s1.08 2.91 1.23 3.11c.15.2 2.11 3.21 5.1 4.5.71.31 1.26.49 1.69.62.71.23 1.36.2 1.87.12.57-.08 1.77-.72 2.02-1.42.25-.7.25-1.31.17-1.43-.08-.12-.27-.2-.57-.35Z"/>
          </svg>
          <span>Quiero grabarlo</span>
        </a>
      </div>
    </section>
    <!-- Loading modal -->
    <div id="loading" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="loading-title">
      <div class="rounded-2xl border border-neutral-700 bg-neutral-900/90 p-6 text-center shadow-2xl w-72">
        <div class="mx-auto mb-4 h-12 w-12 rounded-full border-4 border-indigo-500/30 border-t-indigo-400 animate-spin"></div>
        <p id="loading-title" class="text-neutral-100 font-semibold">Generando tu guion…</p>
        <p class="text-neutral-400 text-xs mt-1">Unos segundos, por favor</p>
      </div>
    </div>
    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
      <div class="rounded-xl border border-neutral-700 bg-neutral-900/90 text-neutral-100 px-4 py-2 shadow-2xl">
        <span id="toast-text">Hecho</span>
      </div>
    </div>
  </main>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
  const API_URL = "https://hook.eu1.make.com/yjamhggycrrranolpeb5fec5d3ibkxmk"; // <- Cambia esto
  const WA_NUM = "34665651344"; // <- Tu WhatsApp

  // Turnstile callback: guarda el token más reciente por si el input oculto aún no está presente
  window.onTS = function(token){ window.__tsToken = token; };

  const form = document.getElementById('guion-form');
  const msg  = document.getElementById('msg');
  const out  = document.getElementById('resultado');
  const loader = document.getElementById('loading');
  const submitBtn = document.getElementById('submit-btn');
  const toast = document.getElementById('toast');
  const toastText = document.getElementById('toast-text');
  let toastTimer;
  function showToast(text){
    if(!toast || !toastText) return;
    toastText.textContent = text || 'Hecho';
    toast.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.add('hidden'), 1800);
  }
  async function copyTextToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    // Fallback
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly','');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }
  function showLoading(){
    if(loader){ loader.classList.remove('hidden'); loader.classList.add('flex'); }
    if(submitBtn){ submitBtn.disabled = true; submitBtn.classList.add('opacity-60','cursor-not-allowed'); }
  }
  function hideLoading(){
    if(loader){ loader.classList.add('hidden'); loader.classList.remove('flex'); }
    if(submitBtn){ submitBtn.disabled = false; submitBtn.classList.remove('opacity-60','cursor-not-allowed'); }
  }

  // Captura UTMs si existen
  const params = new URLSearchParams(location.search);
  const UTM = {
    utm_source: params.get('utm_source') || '',
    utm_medium: params.get('utm_medium') || '',
    utm_campaign: params.get('utm_campaign') || '',
    utm_content: params.get('utm_content') || '',
    utm_term: params.get('utm_term') || ''
  };

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = 'Generando...';
    const fd = new FormData(form);
    const tsToken = document.querySelector('input[name="cf-turnstile-response"]')?.value || '';

    const payload = {
      nombre: fd.get('nombre'),
      email: fd.get('email'),
      instagram: (fd.get('instagram')||'').replace(/^@/, ''),
      telefono: fd.get('telefono') || '',
      ciudad: fd.get('ciudad') || '',
      sector: fd.get('sector'),
      objetivo: fd.get('objetivo') || '',
      diferencial: fd.get('diferencial') || '',
      competidor: fd.get('competidor') || '',
      consent: !!fd.get('consent'),
      turnstileToken: tsToken || window.__tsToken || '',
      ...UTM
    };

    // --- Front firewall (no enviar a Make si huele mal) ---
    const auditText = [
      payload.nombre, payload.sector, payload.objetivo,
      payload.diferencial, payload.ciudad, payload.instagram
    ].filter(Boolean).join(' ').toLowerCase();

    const RE_PROFANITY = /\b(puta|puto|mierda|cabr[oó]n|gilipollas|coñ[oa]|joder|hostia|follar|sexo|porn(?:o|ografía)|xxx|onlyfans|xvideos|xnxx|redtube|dildo|vibrador|pene|vagina|tetas?|pechos|nalgas|verga|pito)\b/i;
    const RE_INJECTION = /\b(ignore (?:all|previous|instructions)|system prompt|act as|jailbreak|developer mode|bypass)\b/i;
    const RE_HTMLJS = /<\s*(script|img|iframe|style|a)\b|on(?:error|load)\s*=|javascript:/i;
    const RE_IG = /^$|^https?:\/\/(?:www\.)?instagram\.com\//i;

    const honeypot = fd.get('empresa');
    if (honeypot) { msg.textContent = 'Error: contenido no permitido (bot)'; return; }

    if (auditText.length > 1500 || RE_PROFANITY.test(auditText) || RE_INJECTION.test(auditText) || RE_HTMLJS.test(auditText)) {
      msg.textContent = 'Por favor, usa lenguaje profesional y evita código/HTML.';
      return;
    }
    if (payload.competidor && !RE_IG.test(payload.competidor.trim())) {
      msg.textContent = 'La URL de competidor debe ser de Instagram.';
      return;
    }

    try{
      showLoading();
      const res = await fetch(API_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'text/plain', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });
      //const data = await res.json();
      const raw = await res.text();
      let data;
      try { data = raw ? JSON.parse(raw) : null; }
      catch { throw new Error('Respuesta no válida del servidor: ' + (raw ? raw.slice(0,180) : '(vacío)')); }
      if (!res.ok || !data || data.error) {
        const serverMsg = (data && data.error) ? data.error : (raw ? raw.slice(0,180) : 'Error en servidor');
        throw new Error(serverMsg);
      }
      

      const g = data.guion;
      document.getElementById('guion').innerHTML = `
        <p><span class="text-neutral-400">Gancho:</span> ${g.gancho}</p>
        <p><span class="text-neutral-400">Problema:</span> ${g.problema}</p>
        <p><span class="text-neutral-400">Solución:</span> ${g.solucion}</p>
        <p><span class="text-neutral-400">CTA:</span> ${g.cta}</p>
      `;

      // ---- Normalización robusta de estructuras (soporta texto/array/objeto) ----
      // Convierte string u array separado en lista de strings
      function toList(val) {
        if (Array.isArray(val)) return val;
        if (typeof val === 'string') {
          return val.split(/[•·\n,;]|(?:\s[—–-]\s)/g).map(s=>s.trim()).filter(Boolean);
        }
        return [];
      }

      // Parsea 'plano a plano' en formato string:
      // "0-2: ACCIÓN — TEXTO_PANTALLA — Voz: VOZ"
      function parsePlano(src) {
        if (Array.isArray(src)) return src;
        if (src && typeof src === 'object') return [src];
        if (typeof src === 'string') {
          const lines = src.split(/\n+/).map(l=>l.trim()).filter(Boolean);
          return lines.map(l => {
            // separar "segundos: resto"
            const m = l.match(/^\s*([^:]+):\s*(.+)$/);
            const segundos = m ? m[1].trim() : '';
            const resto = m ? m[2] : l;
            // Extraer voz si viene al final
            let voz = '';
            const vozMatch = resto.match(/Voz:\s*(.+)$/i);
            if (vozMatch) voz = vozMatch[1].trim();
            // Separar acción y texto_pantalla por guiones (— – -)
            const partes = resto.replace(/Voz:\s*.+$/i, '').split(/\s?[—–-]\s?/);
            const accion = (partes[0] || '').trim();
            const texto_pantalla = (partes[1] || '').trim();
            return { segundos, accion, texto_pantalla, voz };
          });
        }
        return [];
      }

      // Origen posible en raíz o dentro de guion (por si Make devuelve anidado)
      const planoRaw = (data.plano_a_plano ?? data.plano ?? data.plano_a_aplano ?? g?.plano_a_plano ?? g?.plano ?? g?.plano_a_aplano ?? '');
      const planoArr = parsePlano(planoRaw);

      const variantesArr = toList(data.variantes_gancho ?? g?.variantes_gancho);
      const checklistArr = toList(data.checklist_diy ?? g?.checklist_diy);

      document.getElementById('plano').innerHTML = planoArr.map(p =>
        `<p><strong>${p.segundos || ''}:</strong> ${p.accion || ''} · <em class="text-neutral-300">${p.texto_pantalla || ''}</em> · Voz: ${p.voz || ''}</p>`
      ).join('');
      document.getElementById('variantes').innerHTML = variantesArr.map(v=>`<li>${v}</li>`).join('');
      document.getElementById('checklist').innerHTML = checklistArr.map(v=>`<li>${v}</li>`).join('');

      const fullText = `GANCHO: ${g.gancho}\nPROBLEMA: ${g.problema}\nSOLUCIÓN: ${g.solucion}\nCTA: ${g.cta}\n\nPLANO A PLANO:\n` +
        planoArr.map(p=>`${p.segundos || ''}: ${p.accion || ''} | ${p.texto_pantalla || ''} | Voz: ${p.voz || ''}`).join('\n');

      document.getElementById('copiar').onclick = async ()=>{
        const ok = await copyTextToClipboard(fullText);
        if(ok){
          showToast('Guion copiado ✅');
        }else{
          showToast('No se pudo copiar. Selecciónalo manualmente.');
        }
      };
      const wa = document.getElementById('whatsapp');
      wa.href = `https://wa.me/${WA_NUM}?text=${encodeURIComponent('Quiero grabar este guion:\n\n' + fullText)}`;

      hideLoading();
      out.classList.remove('hidden');
      msg.textContent = '¡Listo!';
      out.scrollIntoView({ behavior: 'smooth' });
    }catch(err){
      hideLoading();
      msg.textContent = 'Error: ' + err.message;
    }
  });
  </script>
</body>
</html>
